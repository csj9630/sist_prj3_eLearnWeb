<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">
<head>
<meta charset="UTF-8">
<title>결제하기</title>
<link rel="stylesheet" href="/css/user-mypage.css">
<script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
<script src="https://js.tosspayments.com/v1/payment"></script>

<script th:inline="javascript">
    function payToss() {
        var clientKey = 'test_ck_Z1aOwX7K8mz4qRa9nBwA3yQxzvNP'; 
        var tossPayments = TossPayments(clientKey);
        var orderId = 'ORDER_' + new Date().getTime(); 
        
        var amount = /*[[${totalSum}]]*/ 0; // Controller 변수명 확인 필요 (totalSum 또는 totalPrice)
        if(amount == 0) amount = /*[[${totalPrice}]]*/ 0; // 안전장치

        var customerName = '수강생'; // 고정값 사용 (요구사항 반영)
        
        if(amount <= 0) { alert("결제할 금액이 없습니다."); return; }

        tossPayments.requestPayment('카드', { 
            amount: amount, 
            orderId: orderId, 
            orderName: '인프런 강의 결제', 
            customerName: customerName, 
            successUrl: window.location.origin + '/user/payment/toss/success',
            failUrl: window.location.origin + '/user/payment/fail_page',
        });
    }
</script>
</head>
<body>
    <div th:replace="~{fragments/MyHeader :: header}"></div>

    <div class="mypage-container" style="display:block; width: 1000px; margin: 50px auto;">
        <h2 class="page-title">결제하기</h2>

        <div style="display:flex; gap:30px;">
            <div style="flex:2;">
                <h3 style="font-size:18px; margin-bottom:15px; border-bottom:1px solid #333; padding-bottom:10px;">주문 상품 정보</h3>
                <div class="purchase-list-container">
                    <th:block th:each="item : ${payList}">
                        <div class="purchase-card" style="padding:15px;">
                            <div class="p-left">
                                <div class="p-thumb" style="width:100px; height:60px;">
                                    <img th:src="${item.lectThumbnail}" onerror="this.src='https://via.placeholder.com/100x60'">
                                </div>
                                <div class="p-info">
                                    <h4 th:text="${item.lectName}">강의명</h4>
                                    <span th:text="${item.instName}">강사명</span>
                                </div>
                            </div>
                            <div class="p-right">
                                <span class="p-price" th:text="${#numbers.formatInteger(item.price, 0, 'COMMA') + '원'}">가격</span>
                            </div>
                        </div>
                    </th:block>
                </div>
            </div>

            <div style="flex:1; background:#f8f9fa; padding:25px; border-radius:8px; height:fit-content; border:1px solid #eee;">
                <h3 style="font-size:18px; margin-bottom:20px; font-weight:bold;">결제 정보</h3>
                <div style="margin-bottom:20px; color:#555; font-size:14px; line-height:1.6;">
                    <p>위 주문 내용을 확인하였으며,<br>결제 진행에 동의합니다.</p>
                </div>
                <hr style="margin:20px 0; border:0; border-top:1px solid #ddd;">
                <div style="display:flex; justify-content:space-between; margin-bottom:25px; font-weight:bold; font-size:20px;">
                    <span>총 결제금액</span>
                    <span style="color:#00c471;" th:text="${#numbers.formatInteger(totalSum != null ? totalSum : totalPrice, 0, 'COMMA') + '원'}">0원</span>
                </div>
                <button type="button" onclick="payToss()" 
                        style="width:100%; padding:16px; background:#00c471; color:white; border:none; border-radius:4px; font-weight:bold; font-size:16px; cursor:pointer;">
                    결제하기
                </button>
            </div>
        </div>
    </div>
</body>
</html>