<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">
<head>
<meta charset="UTF-8">
<title>ì¥ë°”êµ¬ë‹ˆ</title>
<style>
    body { font-family: 'Noto Sans KR', sans-serif; padding: 30px; text-align: center; }
    table { width: 80%; margin: 20px auto; border-collapse: collapse; }
    th, td { border: 1px solid #ddd; padding: 10px; }
    th { background-color: #f2f2f2; }
    .btn { padding: 10px 20px; text-decoration: none; border-radius: 5px; color: white; display: inline-block; margin: 5px;}
    .btn-del { background-color: #e74c3c; }
    .btn-pay { background-color: #3498db; font-size: 18px; }
    .btn-home { background-color: #555; } /* ë’¤ë¡œê°€ê¸° ë²„íŠ¼ ìŠ¤íƒ€ì¼ */
</style>
<script src="https://js.tosspayments.com/v1/payment"></script>
</head>
<body>

    <h2>ğŸ›’ ë‚˜ì˜ ì¥ë°”êµ¬ë‹ˆ</h2>
    
    <div style="text-align: right; width: 80%; margin: 0 auto;">
        <a href="/" class="btn btn-home">ğŸ  ë©”ì¸ìœ¼ë¡œ</a>
    </div>

    <div th:if="${#lists.isEmpty(cartList)}">
        <p>ì¥ë°”êµ¬ë‹ˆê°€ ë¹„ì–´ìˆìŠµë‹ˆë‹¤.</p>
    </div>

    <div th:if="${not #lists.isEmpty(cartList)}">
        <table>
            <thead>
                <tr>
                    <th>ì„ íƒ</th>
                    <th>ì´ë¯¸ì§€</th>
                    <th>ê°•ì˜ëª…</th>
                    <th>ê°•ì‚¬</th>
                    <th>ê°€ê²©</th>
                    <th>ê´€ë¦¬</th>
                </tr>
            </thead>
            <tbody>
                <tr th:each="item : ${cartList}">
                    <td><input type="checkbox" name="chkLect" th:value="${item.lectId}" th:data-price="${item.price}" checked onchange="calcTotal()"></td>
                    <td><img th:src="@{/images/{img}(img=${item.lectThumbnail})}" width="50"></td>
                    <td th:text="${item.lectName}"></td>
                    <td th:text="${item.instName}"></td>
                    <td th:text="${#numbers.formatInteger(item.price, 0, 'COMMA')} + 'ì›'"></td>
                    <td><a th:href="@{/user/payment/delLectFromCart(lectId=${item.lectId})}" class="btn btn-del">ì‚­ì œ</a></td>
                </tr>
            </tbody>
        </table>

        <h3>ì´ ê²°ì œê¸ˆì•¡: <span id="totalPrice">0</span>ì›</h3>
        <button class="btn btn-pay" onclick="requestPayment()">ê²°ì œí•˜ê¸°</button>
    </div>

    <script th:inline="javascript">
        // (ê¸°ì¡´ ìŠ¤í¬ë¦½íŠ¸ ìœ ì§€ - ìƒëµ ì—†ì´ í¬í•¨)
        var clientKey = 'test_ck_Z1aOwX7K8mz4qRa9nBwA3yQxzvNP';
        var tossPayments = TossPayments(clientKey);

        function calcTotal() {
            let total = 0;
            document.querySelectorAll('input[name="chkLect"]:checked').forEach(function(chk) {
                total += parseInt(chk.getAttribute('data-price'));
            });
            document.getElementById('totalPrice').innerText = total.toLocaleString();
        }

        function requestPayment() {
            let totalAmount = parseInt(document.getElementById('totalPrice').innerText.replace(/,/g, ''));
            if (totalAmount === 0) { alert("ê²°ì œí•  ê°•ì˜ë¥¼ ì„ íƒí•´ì£¼ì„¸ìš”."); return; }

            // ì„ íƒëœ ê°•ì˜ ID ìˆ˜ì§‘
            let selectedIds = [];
            document.querySelectorAll('input[name="chkLect"]:checked').forEach(function(chk) {
                selectedIds.push(chk.value);
            });
            let lectIdsStr = selectedIds.join(",");

            // í† ìŠ¤ ê²°ì œ ìš”ì²­
            tossPayments.requestPayment('ì¹´ë“œ', {
                amount: totalAmount,
                orderId: 'ORDER_' + new Date().getTime(),
                orderName: 'ê°•ì˜ ê²°ì œ',
                customerName: 'í…ŒìŠ¤íŠ¸ìœ ì €',
                successUrl: window.location.origin + '/user/payment/toss/success?lectIds=' + lectIdsStr,
                failUrl: window.location.origin + '/user/payment/fail_page',
            });
        }
        
        // í˜ì´ì§€ ë¡œë“œ ì‹œ ì´ˆê¸° ê³„ì‚°
        calcTotal();
    </script>
</body>
</html>