<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <title>ë‚´ ì¥ë°”êµ¬ë‹ˆ</title>
    
    <script src="https://js.tosspayments.com/v1/payment"></script>
    
    <style>
        body { font-family: 'Noto Sans KR', sans-serif; padding: 20px; }
        h2 { border-bottom: 2px solid #333; padding-bottom: 10px; }
        table { width: 100%; border-collapse: collapse; margin-top: 20px; }
        th, td { border: 1px solid #ddd; padding: 12px; text-align: center; }
        th { background-color: #f8f9fa; }
        .total-area { text-align: right; margin-top: 20px; font-size: 1.5em; font-weight: bold; }
        .btn-pay { background-color: #007bff; color: white; border: none; padding: 15px 30px; font-size: 1.2em; cursor: pointer; border-radius: 5px; }
        .btn-pay:hover { background-color: #0056b3; }
        .btn-del { color: red; text-decoration: none; }
    </style>
</head>
<body>

    <h2>ğŸ›’ ë‚´ ì¥ë°”êµ¬ë‹ˆ</h2>

<table>
        <thead>
            <tr>
                <th style="width: 50px;">
                    <input type="checkbox" id="chkAll" checked onclick="toggleAll(this)">
                </th>
                <th>ì´ë¯¸ì§€</th>
                <th>ê°•ì˜ëª…</th>
                <th>ê°•ì‚¬ëª…</th>
                <th>ê°€ê²©</th>
                <th>ê´€ë¦¬</th>
            </tr>
        </thead>
        <tbody>
            <tr th:if="${#lists.isEmpty(cartList)}">
                <td colspan="6" style="padding: 50px;">ì¥ë°”êµ¬ë‹ˆê°€ ë¹„ì–´ìˆìŠµë‹ˆë‹¤.</td>
            </tr>
            
            <tr th:each="cart : ${cartList}">
                <td>
                    <input type="checkbox" name="cartItem" class="chk-item" 
                           th:value="${cart.lectId}" 
                           th:data-price="${cart.price}" 
                           checked 
                           onclick="calcTotal()">
                </td>
                <td>
                    <img th:src="@{/images/lecture/{img}(img=${cart.lectThumbnail})}" width="80" alt="ê°•ì˜"
                         onerror="this.src='https://placehold.co/80'"/>
                </td>
                <td th:text="${cart.lectName}" style="text-align: left; font-weight: bold;">ìë°” ê°•ì˜</td>
                <td th:text="${cart.instname}">ê¹€ê°•ì‚¬</td> 
                <td th:text="${#numbers.formatInteger(cart.price, 0, 'COMMA')} + 'ì›'">50,000ì›</td>
                <td>
                    <a th:href="@{/user/payment/delLectFromCart(lectId=${cart.lectId})}" class="btn-del">ì‚­ì œ</a>
                </td>
            </tr>
        </tbody>
    </table>

    <div class="total-area" th:if="${not #lists.isEmpty(cartList)}">
        ì´ ê²°ì œ ê¸ˆì•¡: <span id="totalPriceDisplay" style="color: #e74c3c;" 
                       th:text="${#numbers.formatInteger(#aggregates.sum(cartList.![price]), 0, 'COMMA')}">0</span>ì›
        <br><br>
        <button type="button" class="btn-pay" onclick="payToss()">ì„ íƒ ê°•ì˜ ê²°ì œí•˜ê¸°</button>
    </div>

    <div class="total-area" th:if="${not #lists.isEmpty(cartList)}">
        ì´ ê²°ì œ ê¸ˆì•¡: <span style="color: #e74c3c;" th:text="${#numbers.formatInteger(#aggregates.sum(cartList.![price]), 0, 'COMMA')}">0</span>ì›
        <br><br>
        <button type="button" class="btn-pay" onclick="payToss()">ê²°ì œí•˜ê¸°</button>
    </div>

    <script th:inline="javascript">
        // 1. ì „ì²´ ì„ íƒ/í•´ì œ
        function toggleAll(source) {
            const checkboxes = document.querySelectorAll('.chk-item');
            checkboxes.forEach(cb => cb.checked = source.checked);
            calcTotal();
        }

        // 2. ì´ ê¸ˆì•¡ ì¬ê³„ì‚°
        function calcTotal() {
            let total = 0;
            const checkboxes = document.querySelectorAll('.chk-item:checked');
            
            checkboxes.forEach(cb => {
                total += parseInt(cb.getAttribute('data-price'));
            });

            // í™”ë©´ ìˆ«ì ì—…ë°ì´íŠ¸ (ì²œë‹¨ìœ„ ì½¤ë§ˆ)
            document.getElementById('totalPriceDisplay').innerText = total.toLocaleString();
        }

        // 3. ê²°ì œ ìš”ì²­ (ìˆ˜ì •ë¨)
        function payToss() {
            var clientKey = 'test_ck_Z1aOwX7K8mz4qRa9nBwA3yQxzvNP'; 
            var tossPayments = TossPayments(clientKey);
            var orderId = 'ORDER_' + new Date().getTime(); 
            var userName = /*[[${session.userName}]]*/ 'êµ¬ë§¤ì';

            // [í•µì‹¬] ì„ íƒëœ ê°•ì˜ë“¤ì˜ ê°€ê²© í•©ì‚° ë° ID ìˆ˜ì§‘
            let totalAmount = 0;
            let selectedIds = [];
            
            const checkboxes = document.querySelectorAll('.chk-item:checked');
            checkboxes.forEach(cb => {
                totalAmount += parseInt(cb.getAttribute('data-price'));
                selectedIds.push(cb.value); // ê°•ì˜ ID ìˆ˜ì§‘
            });

            if(totalAmount <= 0) {
                alert("ê²°ì œí•  ê°•ì˜ë¥¼ ì„ íƒí•´ì£¼ì„¸ìš”.");
                return;
            }

            // [í•µì‹¬] ì„±ê³µ URL ë’¤ì— ì„ íƒëœ ê°•ì˜ IDë“¤ì„ ë¶™ì—¬ì„œ ë³´ëƒ„ (ì˜ˆ: ...?lectIds=L1,L2,L3)
            let successUrl = window.location.origin + '/user/payment/toss/success?lectIds=' + selectedIds.join(',');

            tossPayments.requestPayment('ì¹´ë“œ', { 
                amount: totalAmount, 
                orderId: orderId, 
                orderName: 'ì´ëŸ¬ë‹ ê°•ì˜ ' + selectedIds.length + 'ê±´', 
                customerName: userName, 
                successUrl: successUrl, 
                failUrl: window.location.origin + '/user/payment/toss/fail', 
            })
            .catch(function (error) {
                if (error.code === 'USER_CANCEL') {
                    // ì·¨ì†Œ ì‹œ ì¡°ìš©íˆ ë„˜ì–´ê°
                } else {
                    alert('ê²°ì œ ì‹¤íŒ¨: ' + error.message);
                }
            });
        }
    </script>

</body>
</html>