<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">
<head>
<meta charset="UTF-8">
<title>ì¥ë°”êµ¬ë‹ˆ</title>
<link rel="stylesheet" href="/css/user-mypage.css">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
<script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
<script src="https://js.tosspayments.com/v1/payment"></script>

<script>
    // [ê¸°ì¡´ ìŠ¤í¬ë¦½íŠ¸ ìœ ì§€]
    var clientKey = 'test_ck_Z1aOwX7K8mz4qRa9nBwA3yQxzvNP';
    var tossPayments = TossPayments(clientKey);

    function calcTotal() {
        let total = 0;
        document.querySelectorAll('input[name="chkLect"]:checked').forEach(function(chk) {
            total += parseInt(chk.getAttribute('data-price'));
        });
        document.getElementById('totalPrice').innerText = total.toLocaleString();
    }

    function requestPayment() {
        let totalAmount = parseInt(document.getElementById('totalPrice').innerText.replace(/,/g, ''));
        if (totalAmount === 0) { alert("ê²°ì œí•  ê°•ì˜ë¥¼ ì„ íƒí•´ì£¼ì„¸ìš”."); return; }

        let selectedIds = [];
        document.querySelectorAll('input[name="chkLect"]:checked').forEach(function(chk) {
            selectedIds.push(chk.value);
        });
        let lectIdsStr = selectedIds.join(",");

        tossPayments.requestPayment('ì¹´ë“œ', {
            amount: totalAmount,
            orderId: 'ORDER_' + new Date().getTime(),
            orderName: 'ê°•ì˜ ê²°ì œ',
            customerName: 'ìˆ˜ê°•ìƒ',
            successUrl: window.location.origin + '/user/payment/toss/success?lectIds=' + lectIdsStr,
            failUrl: window.location.origin + '/user/payment/fail_page',
        });
    }
    
    // í˜ì´ì§€ ë¡œë“œ ì‹œ ì´ˆê¸° ê³„ì‚° ë° ì´ë²¤íŠ¸ ë°”ì¸ë”©
    $(document).ready(function() {
        calcTotal();
        $("#checkAll").change(function(){
            $("input[name='chkLect']").prop('checked', $(this).prop("checked"));
            calcTotal();
        });
        $("input[name='chkLect']").change(function(){
            calcTotal();
            if(!$(this).prop("checked")) $("#checkAll").prop('checked', false);
        });
    });
</script>
</head>
<body>
    <div th:replace="~{fragments/MyHeader :: header}"></div>

    <div class="mypage-container" style="display:block; width: 1000px; margin: 50px auto;">
        
        <h2 class="page-title">ğŸ›’ ë‚˜ì˜ ì¥ë°”êµ¬ë‹ˆ</h2>
        
        <div style="text-align: right; margin-bottom: 20px;">
            <a href="/" class="btn-outline" style="font-size:14px; padding:8px 16px;">ğŸ  ë©”ì¸ìœ¼ë¡œ</a>
        </div>

        <div th:if="${#lists.isEmpty(cartList)}" class="empty-state">
            <i class="fas fa-shopping-cart"></i>
            <p>ì¥ë°”êµ¬ë‹ˆê°€ ë¹„ì–´ìˆìŠµë‹ˆë‹¤.</p>
        </div>

        <div th:unless="${#lists.isEmpty(cartList)}" class="purchase-list-container">
            <div style="padding: 10px; border-bottom: 1px solid #eee; margin-bottom: 10px;">
                <label><input type="checkbox" id="checkAll" checked> ì „ì²´ ì„ íƒ</label>
            </div>

            <th:block th:each="cart : ${cartList}">
                <div class="purchase-card">
                    <div class="p-left">
                        <input type="checkbox" name="chkLect" th:value="${cart.lectId}" th:data-price="${cart.price}" checked style="margin-right:15px; transform:scale(1.2);">
                        <div class="p-thumb">
                            <img th:src="${cart.lectThumbnail}" onerror="this.src='https://via.placeholder.com/120x75'">
                        </div>
                        <div class="p-info">
                            <h4 th:text="${cart.lectName}">ê°•ì˜ëª…</h4>
                            <span th:text="${cart.instName}">ê°•ì‚¬ëª…</span>
                        </div>
                    </div>
                    <div class="p-right">
                        <span class="p-price" th:text="${#numbers.formatInteger(cart.price, 0, 'COMMA') + 'ì›'}">ê°€ê²©</span>
                        <button type="button" style="border:none; background:none; cursor:pointer; color:#888;"><i class="fas fa-times"></i></button>
                    </div>
                </div>
            </th:block>

            <div class="cart-footer" style="margin-top: 30px; text-align: right; border-top: 2px solid #333; padding-top: 20px;">
                <span style="font-size: 20px; font-weight: bold; margin-right: 20px;">
                    ì´ ê²°ì œ ê¸ˆì•¡: <span id="totalPrice" style="color: #00c471;">0</span>ì›
                </span>
                <button type="button" onclick="requestPayment()" 
                        style="background:#00c471; color:white; border:none; padding:12px 40px; border-radius:4px; font-size:16px; font-weight:bold; cursor:pointer;">
                    ê²°ì œí•˜ê¸°
                </button>
            </div>
        </div>
    </div>
</body>
</html>