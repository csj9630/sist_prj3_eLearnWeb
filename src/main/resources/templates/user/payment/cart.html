<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">
<head>
<meta charset="UTF-8">
<title>ì¥ë°”êµ¬ë‹ˆ</title>
<<<<<<< HEAD
<style>
    body { font-family: 'Noto Sans KR', sans-serif; padding: 30px; text-align: center; }
    table { width: 80%; margin: 20px auto; border-collapse: collapse; }
    th, td { border: 1px solid #ddd; padding: 10px; }
    th { background-color: #f2f2f2; }
    .btn { padding: 10px 20px; text-decoration: none; border-radius: 5px; color: white; display: inline-block; margin: 5px;}
    .btn-del { background-color: #e74c3c; }
    .btn-pay { background-color: #3498db; font-size: 18px; }
    .btn-home { background-color: #555; } /* ë’¤ë¡œê°€ê¸° ë²„íŠ¼ ìŠ¤íƒ€ì¼ */
</style>
<script src="https://js.tosspayments.com/v1/payment"></script>
=======
<link rel="stylesheet" href="/css/user-mypage.css">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
<script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
<script src="https://js.tosspayments.com/v1/payment"></script>

<style>
    .btn-delete-selected {
        padding: 6px 14px; background-color: #fff; border: 1px solid #dee2e6;
        border-radius: 4px; color: #495057; font-size: 13px; cursor: pointer; transition: all 0.2s;
    }
    .btn-delete-selected:hover { background-color: #f8f9fa; border-color: #c1c8cd; color: #333; }
</style>

<script>
    //  í† ìŠ¤ ê²°ì œ í‚¤ ì„¤ì •
    var clientKey = 'test_ck_Z1aOwX7K8mz4qRa9nBwA3yQxzvNP';
    var tossPayments = TossPayments(clientKey);

    // ê°€ê²© ê³„ì‚° ë° ê°œìˆ˜ ì—…ë°ì´íŠ¸
    function calcTotal() {
        let total = 0;
        const checkboxes = document.querySelectorAll('input[name="chkLect"]:checked');
        const allCheckboxes = document.querySelectorAll('input[name="chkLect"]');
        
        checkboxes.forEach(function(chk) {
            total += parseInt(chk.getAttribute('data-price'));
        });
        document.getElementById('totalPrice').innerText = total.toLocaleString();

        // ì„ íƒ ê°œìˆ˜ / ì „ì²´ ê°œìˆ˜ ì—…ë°ì´íŠ¸
        if(document.getElementById('selectedCountText')) {
            document.getElementById('selectedCountText').innerText = checkboxes.length + ' / ' + allCheckboxes.length;
        }
    }

    // ê²°ì œ ìš”ì²­ (í† ìŠ¤ SDK ì‚¬ìš©)
    function requestPayment() {
        let totalAmount = parseInt(document.getElementById('totalPrice').innerText.replace(/,/g, ''));
        if (totalAmount === 0) { alert("ê²°ì œí•  ê°•ì˜ë¥¼ ì„ íƒí•´ì£¼ì„¸ìš”."); return; }

        let selectedIds = [];
        document.querySelectorAll('input[name="chkLect"]:checked').forEach(function(chk) {
            selectedIds.push(chk.value);
        });
        let lectIdsStr = selectedIds.join(",");

        tossPayments.requestPayment('ì¹´ë“œ', {
            amount: totalAmount,
            orderId: 'ORDER_' + new Date().getTime(),
            orderName: 'ê°•ì˜ ê²°ì œ',
            customerName: 'ìˆ˜ê°•ìƒ',
            successUrl: window.location.origin + '/user/payment/toss/success?lectIds=' + lectIdsStr,
            failUrl: window.location.origin + '/user/payment/fail_page',
        });
    }
    
    // ê°œë³„ ì‚­ì œ (X ë²„íŠ¼)
    function removeCartItem(lectId) {
        if(!confirm("ì´ ê°•ì˜ë¥¼ ì¥ë°”êµ¬ë‹ˆì—ì„œ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?")) return;
        requestRemoveCart([lectId]); // ë°°ì—´ë¡œ ë‹´ì•„ì„œ ë³´ëƒ„
    }

    // ì„ íƒ ì‚­ì œ (ë²„íŠ¼)
    function removeSelectedCartItems() {
        const checkboxes = document.querySelectorAll('input[name="chkLect"]:checked');
        if(checkboxes.length === 0) { alert("ì‚­ì œí•  ê°•ì˜ë¥¼ ì„ íƒí•´ì£¼ì„¸ìš”."); return; }
        if(!confirm("ì„ íƒí•œ " + checkboxes.length + "ê°œì˜ ê°•ì˜ë¥¼ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?")) return;

        const lectIds = [];
        checkboxes.forEach(cb => lectIds.push(cb.value));
        requestRemoveCart(lectIds);
    }

    // ì‚­ì œ AJAX (traditional: true í•„ìˆ˜)
    function requestRemoveCart(lectIds) {
        $.ajax({
            url: "/user/payment/delLectFromCart",
            type: "GET",       
            data: { lectIds: lectIds },
            success: function(response) {
                if(response === "success") {
                    alert("ì‚­ì œë˜ì—ˆìŠµë‹ˆë‹¤.");
                    location.reload();
                } else {
                    alert("ì‚­ì œ ì‹¤íŒ¨");
                }
            },
            error: function(xhr, status, error) { 
                console.error("Error:", error);
                console.error("Status:", status);
                alert("ì„œë²„ í†µì‹  ì˜¤ë¥˜"); 
            }
        });
    }
    
    // ì´ë²¤íŠ¸ ë°”ì¸ë”©
    $(document).ready(function() {
        calcTotal();
        $("#checkAll").change(function(){
            $("input[name='chkLect']").prop('checked', $(this).prop("checked"));
            calcTotal();
        });
        $("input[name='chkLect']").change(function(){
            calcTotal();
            var total = $("input[name='chkLect']").length;
            var checked = $("input[name='chkLect']:checked").length;
            $("#checkAll").prop('checked', total === checked);
        });
    });
</script>
>>>>>>> refs/heads/dev0220-2
</head>
<body>
    <div th:replace="~{fragments/MyHeader :: header}"></div>

<<<<<<< HEAD
    <h2>ğŸ›’ ë‚˜ì˜ ì¥ë°”êµ¬ë‹ˆ</h2>
    
    <div style="text-align: right; width: 80%; margin: 0 auto;">
        <a href="/" class="btn btn-home">ğŸ  ë©”ì¸ìœ¼ë¡œ</a>
=======
    <div class="mypage-container" style="display:block; width: 1000px; margin: 50px auto;">
        
        <h2 class="page-title">ë‚˜ì˜ ì¥ë°”êµ¬ë‹ˆ</h2>
        
        <div style="text-align: right; margin-bottom: 20px;">
            <a href="/" class="btn-outline" style="font-size:14px; padding:8px 16px; font-weight: bold;">ë©”ì¸ í˜ì´ì§€ë¡œ</a>
        </div>

        <div th:if="${#lists.isEmpty(cartList)}" class="empty-state">
            <i class="fas fa-shopping-cart"></i>
            <p>ì¥ë°”êµ¬ë‹ˆê°€ ë¹„ì–´ìˆìŠµë‹ˆë‹¤.</p>
        </div>

        <div th:unless="${#lists.isEmpty(cartList)}" class="purchase-list-container">
            
            <div style="padding: 10px; border-bottom: 1px solid #eee; margin-bottom: 10px; display:flex; justify-content:space-between; align-items:center;">
                <div>
                    <label style="cursor:pointer;">
                        <input type="checkbox" id="checkAll" checked> 
                        <span style="font-weight:bold; margin-left:5px;">ì „ì²´ ì„ íƒ</span>
                    </label>
                    <span id="selectedCountText" style="margin-left: 10px; font-size: 14px; color: #666;">0 / 0</span>
                </div>
                <button type="button" class="btn-delete-selected" onclick="removeSelectedCartItems()">ì„ íƒ ì‚­ì œ</button>
            </div>

            <th:block th:each="cart : ${cartList}">
                <div class="purchase-card">
                    <div class="p-left">
                        <input type="checkbox" name="chkLect" th:value="${cart.lectId}" th:data-price="${cart.price}" checked style="margin-right:15px; transform:scale(1.2);">
                        <div class="p-thumb">
                            <img th:src="${cart.lectThumbnail}" onerror="this.src='https://via.placeholder.com/120x75'">
                        </div>
                        <div class="p-info">
                            <h4 th:text="${cart.lectName}">ê°•ì˜ëª…</h4>
                            <span th:text="${cart.instName}">ê°•ì‚¬ëª…</span>
                        </div>
                    </div>
                    <div class="p-right">
                        <span class="p-price" th:text="${#numbers.formatInteger(cart.price, 0, 'COMMA') + 'ì›'}">ê°€ê²©</span>
                        
                        <button type="button" 
                                th:data-id="${cart.lectId}"
                                onclick="removeCartItem(this.getAttribute('data-id'))"
                                style="border:none; background:none; cursor:pointer; color:#888;">
                            <i class="fas fa-times"></i>
                        </button>
                        
                    </div>
                </div>
            </th:block>

            <div class="cart-footer" style="margin-top: 30px; text-align: right; border-top: 2px solid #333; padding-top: 20px;">
                <span style="font-size: 20px; font-weight: bold; margin-right: 20px;">
                    ì´ ê²°ì œ ê¸ˆì•¡: <span id="totalPrice" style="color: #00c471;">0</span>ì›
                </span>
                <button type="button" onclick="requestPayment()" 
                        style="background:#00c471; color:white; border:none; padding:12px 40px; border-radius:4px; font-size:16px; font-weight:bold; cursor:pointer;">
                    ê²°ì œí•˜ê¸°
                </button>
            </div>
        </div>
>>>>>>> refs/heads/dev0220-2
    </div>
<<<<<<< HEAD

    <div th:if="${#lists.isEmpty(cartList)}">
        <p>ì¥ë°”êµ¬ë‹ˆê°€ ë¹„ì–´ìˆìŠµë‹ˆë‹¤.</p>
    </div>

    <div th:if="${not #lists.isEmpty(cartList)}">
        <table>
            <thead>
                <tr>
                    <th>ì„ íƒ</th>
                    <th>ì´ë¯¸ì§€</th>
                    <th>ê°•ì˜ëª…</th>
                    <th>ê°•ì‚¬</th>
                    <th>ê°€ê²©</th>
                    <th>ê´€ë¦¬</th>
                </tr>
            </thead>
            <tbody>
                <tr th:each="item : ${cartList}">
                    <td><input type="checkbox" name="chkLect" th:value="${item.lectId}" th:data-price="${item.price}" checked onchange="calcTotal()"></td>
                    <td><img th:src="@{/images/{img}(img=${item.lectThumbnail})}" width="50"></td>
                    <td th:text="${item.lectName}"></td>
                    <td th:text="${item.instName}"></td>
                    <td th:text="${#numbers.formatInteger(item.price, 0, 'COMMA')} + 'ì›'"></td>
                    <td><a th:href="@{/user/payment/delLectFromCart(lectId=${item.lectId})}" class="btn btn-del">ì‚­ì œ</a></td>
                </tr>
            </tbody>
        </table>

        <h3>ì´ ê²°ì œê¸ˆì•¡: <span id="totalPrice">0</span>ì›</h3>
        <button class="btn btn-pay" onclick="requestPayment()">ê²°ì œí•˜ê¸°</button>
    </div>

    <script th:inline="javascript">
        // (ê¸°ì¡´ ìŠ¤í¬ë¦½íŠ¸ ìœ ì§€ - ìƒëµ ì—†ì´ í¬í•¨)
        var clientKey = 'test_ck_Z1aOwX7K8mz4qRa9nBwA3yQxzvNP';
        var tossPayments = TossPayments(clientKey);

        function calcTotal() {
            let total = 0;
            document.querySelectorAll('input[name="chkLect"]:checked').forEach(function(chk) {
                total += parseInt(chk.getAttribute('data-price'));
            });
            document.getElementById('totalPrice').innerText = total.toLocaleString();
        }

        function requestPayment() {
            let totalAmount = parseInt(document.getElementById('totalPrice').innerText.replace(/,/g, ''));
            if (totalAmount === 0) { alert("ê²°ì œí•  ê°•ì˜ë¥¼ ì„ íƒí•´ì£¼ì„¸ìš”."); return; }

            // ì„ íƒëœ ê°•ì˜ ID ìˆ˜ì§‘
            let selectedIds = [];
            document.querySelectorAll('input[name="chkLect"]:checked').forEach(function(chk) {
                selectedIds.push(chk.value);
            });
            let lectIdsStr = selectedIds.join(",");

            // í† ìŠ¤ ê²°ì œ ìš”ì²­
            tossPayments.requestPayment('ì¹´ë“œ', {
                amount: totalAmount,
                orderId: 'ORDER_' + new Date().getTime(),
                orderName: 'ê°•ì˜ ê²°ì œ',
                customerName: 'í…ŒìŠ¤íŠ¸ìœ ì €',
                successUrl: window.location.origin + '/user/payment/toss/success?lectIds=' + lectIdsStr,
                failUrl: window.location.origin + '/user/payment/fail_page',
            });
        }
        
        // í˜ì´ì§€ ë¡œë“œ ì‹œ ì´ˆê¸° ê³„ì‚°
        calcTotal();
    </script>
=======
>>>>>>> refs/heads/dev0220-2
</body>
</html>