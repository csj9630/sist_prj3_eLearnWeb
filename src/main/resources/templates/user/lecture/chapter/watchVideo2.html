<!doctype html>
<html xmlns:th="http://www.thymeleaf.org">
  <head>
    <meta charset="UTF-8" />
    <title>Insert title here</title>

    <th:block th:replace="~{fragments/cdn :: cdn}"></th:block>

    <style type="text/css">
      body {
        background-color: #a2cba1;
      }

      #wrap {
        margin: 0px auto;
        /* width: 1200px; */
        height: 1000px;
      }

      #header {
        height: 150px;
      }

      #container {
        height: 700px;
      }

      #footer {
        height: 150px;
      }

      .btnSection {
        display: flex;
        justify-content: space-between;
      }

      /* ë™ì˜ìƒê³¼ í•œë²ˆì— ë³´ì—¬ì£¼ê¸° ìœ„í•´ ì²˜ìŒì—ëŠ” íˆ¬ëª…í•˜ê²Œ ìˆ¨ê¹€ */
      .playerSection {
        display: flex;
        justify-content: left;
        text-align: center;
        opacity: 0;
        transition: opacity 0.5s ease-in-out; /* ë¶€ë“œëŸ¬ìš´ ë“±ì¥ íš¨ê³¼ */
      }
      /* ë¡œë”© CSS */
      #loading {
        height: 390px;
        display: flex; /* Flexbox í™œì„±í™” */
        flex-direction: column; /* ì„¸ë¡œ ì •ë ¬ */
        justify-content: center; /* ìˆ˜ì§ ì •ì•™ ì •ë ¬ */
        align-items: center; /* ìˆ˜í‰ ì¤‘ì•™ ì •ë ¬ */
        gap: 15px; /* ìŠ¤í”¼ë„ˆì™€ ë¬¸êµ¬ ì‚¬ì´ì˜ ê°„ê²© */
      }

      /* ë¡œë”©ì´ ì™„ë£Œë˜ë©´ ì´ í´ë˜ìŠ¤ë¥¼ ë¶™ì—¬ì„œ ë³´ì—¬ì¤Œ */
      .playerSection.loaded {
        opacity: 1;
      }
    </style>
    <script th:if="${errorMsg != null}">
      //ì¶œì„ì²´í¬ ì‹¤íŒ¨ ì‹œ ì—ëŸ¬ë©”ì‹œì§€ í›„ ì´ì „ í˜ì´ì§€ë¡œ ë³µê·€.
      alert("[[${errorMsg}]]");
      history.back();
    </script>

    <script th:inline="javascript" type="text/javascript">
      //************* ThymeLeafë¡œ DB ê°’ ì €ì¥ ** *****************
      //IDEì—ì„œ ì—ëŸ¬ í‘œì‹œ ë‚˜ì„œ ì£¼ì„ ê¸°ë²•ìœ¼ë¡œ ë³€ê²½
      const videoJSONArr = /*[[${vdList}]]*/ "default_value";
      const startChptrId = /*[[${startChptrId}]]*/ "default_id";
      const exitUrl = /*[[@{/csj}]]*/ "/";

      console.log(videoJSONArr);

      //*********ì „ì—­ë³€ìˆ˜*****************
      var videoData; // í˜„ì¬ í™”ë©´ì—ì„œ ë³¼ ì˜ìƒì •ë³´.
      var currentIndex = 0; //vdListì˜ í˜„ì¬ index ë²ˆí˜¸
      var beforeIndex = 0; //vdListì˜ í˜„ì¬ index ë²ˆí˜¸
      var player;

      var lastTime = 0; // í˜„ì¬ ì‹œì²­ì‹œê°„
      var realTime = 0; //ì‹¤ì œ ì‹œì²­ì‹œê°„
      const interval = 1000; //ë°˜ë³µ ì¶”ì ì‹œê°„.

      //ì§€ì • ì‹œê°„ë§ˆë‹¤ ì‹¤ì œ ì‹œì²­ ì‹œê°„ì„ ì¶”ì²™í•¨.
      setInterval(() => {
        if (player.getPlayerState() === YT.PlayerState.PLAYING) {
          trackVideoTime(getTime());

          //í…ŒìŠ¤íŠ¸ìš©.
          $("#lastTime").text(lastTime);
          $("#realTime").text(realTime);
        }
      }, interval);

      //í˜ì´ì§€ ë²—ì–´ë‚  ë•Œ ì•Œë¦¼ë©”ì‹œì§€(ì¢…ë£Œ ì™¸ ë°©ë²•ìœ¼ë¡œ)
      var checkUnload = true;
      $(window).on("beforeunload", function () {
        if (checkUnload) {
          return "ì¢…ë£Œ ë²„íŠ¼ ì™¸ ë°©ë²•ìœ¼ë¡œ í˜ì´ì§€ë¥¼ ë²—ì–´ë‚˜ë©´  ë‚´ìš©ì€ ì €ì¥ë˜ì§€ ì•ŠìŠµë‹ˆë‹¤.";
        }
      });

      //*********document.ready***********
      $(function () {
        //JSONArrì—ì„œ num ì»¬ëŸ¼ìœ¼ë¡œ videoJSONê³¼ indexë²ˆí˜¸ Setting
        VideoChapterReady(startChptrId, videoJSONArr);

        //í…ŒìŠ¤íŠ¸ë¥¼ ìœ„í•´ ì¼ë‹¨ ë‹¤ ë³´ì—¬ì£¼ë©´ì„œ ì‹œì‘.
        //$(".playerSection").addClass("loaded");
        //************ ë²„íŠ¼ í• ë‹¹ ******************
        $("#btnExit").click(function () {
          checkUnload = false; //ì•Œë¦¼ ì•ˆëœ¨ê³  ë‚˜ê°€ê¸°.
          uploadRecord();
          location.href = exitUrl;
        }); //click
        $("#btnPrev").click(function () {
          uploadRecord();
          updateCurrentTimeOnTable(currentIndex);
          playVideoByIndex(currentIndex - 1);
        }); //click
        $("#btnNext").click(function () {
          uploadRecord();
          updateCurrentTimeOnTable(currentIndex);
          playVideoByIndex(currentIndex + 1);
        }); //click
      }); //document.ready

      //************ í•¨ìˆ˜ ì •ì˜ ******************
      //ì˜ìƒ ëª©ë¡ ë²„íŠ¼ìœ¼ë¡œ ë‹¤ë¥¸ ì˜ìƒ í‹€ ë•Œ ì‚¬ìš©.
      function changeView(i) {
        updateCurrentTimeOnTable(currentIndex);
        playVideoByIndex(i);
      }

      //ì‹¤ì œ ì‹œì²­ì‹œê°„ì„ ì¶”ì .
      function trackVideoTime(currentTime) {
        const playbackRate = player.getPlaybackRate(); // í˜„ì¬ ì¬ìƒ ì†ë„
        const range = playbackRate + 0.5; //ë²”ìœ„ê°’

        const zeta = currentTime - lastTime;

        //0< (í˜„ì¬ ì‹œê°„ - ë§ˆì§€ë§‰ ì €ì¥ì‹œê°„) < 1.2 ì¼ë•Œë§Œ ì •ìƒ ì¬ìƒ ì¸ì •.
        if (zeta > 0 && zeta < range) {
          realTime += Math.floor(zeta / playbackRate);
          //realTime++;
        } //if

        //ë§ˆì§€ë§‰ ì €ì¥ì‹œê°„ ì—…ë°ì´íŠ¸
        lastTime = currentTime;
      } //func

      //ì´ˆê¸° ì‹œì‘ ë•Œ ì‚¬ìš©.
      //num ì»¬ëŸ¼ìœ¼ë¡œ videoListì—ì„œ ì¼ì¹˜í•˜ëŠ” videoJson í•˜ë‚˜ë¥¼ ì „ì—­ ì €ì¥.
      //currentIndexì— ì°¾ì€ index ë²ˆí˜¸ ì „ì—­ ì €ì¥.
      function VideoChapterReady(targetId, jsonArr) {
        const foundIndex = jsonArr.findIndex(
          (item) => String(item.chptrId) == targetId,
        );

        if (foundIndex !== -1) {
          currentIndex = foundIndex;
        } else {
          currentIndex = 0; // ì—ëŸ¬ ë°©ì§€ìš© ê¸°ë³¸ê°’
        }
        videoData = jsonArr[currentIndex]; //indexë¡œ videoJsonì„ ì „ì—­ ì €ì¥.
        realTime = videoData.actualTime; //DBê°’ ë¡œë“œ :ì‹¤ì œ ì‹œì²­ì‹œê°„
        updateRowHighlight(currentIndex); //ëª©ë¡ì—ì„œ í˜„ì¬ ì˜ìƒ í•˜ì´ë¼ì´íŠ¸.
      } //function

      //ì˜ìƒ ë°”ê¿€ ë•Œ ì“°ëŠ” í•¨ìˆ˜.
      function playVideoByIndex(index) {
        if (index < 0) {
          alert("ì²« ë²ˆì§¸ ê°•ì˜ì…ë‹ˆë‹¤.");
          return;
        }
        if (index >= videoJSONArr.length) {
          alert("ë§ˆì§€ë§‰ ê°•ì˜ì…ë‹ˆë‹¤. ìˆ˜ê³ í•˜ì…¨ìŠµë‹ˆë‹¤!");
          return;
        }

        videoData = videoJSONArr[index]; //ì „ì—­ ë³€ìˆ˜ë¡œ ì˜ìƒ ì •ë³´ ì €ì¥.

        //ì‹œì²­ ì™„ë£Œí•œ ì˜ìƒì¼ ë•Œ ì‹œì‘ì‹œê°„ ì§€ì •(state=2)
        let startTime = videoData.progTime;
        if (videoData.state == 2) {
          startTime = 0; // ì™„ë£Œëœ ì˜ìƒì€ ì²˜ìŒë¶€í„° ì¬ìƒ
        } //if

        document.title = videoData.title; //ë¸Œë¼ìš°ì € ì œëª© ë³€ê²½
        $(".title").text(videoData.title); //<h3> í…ìŠ¤íŠ¸ ë³€ê²½

        //ë³€ê²½ ì „ video ì˜ìƒì‹œê°„ì„ jsonArrì— ê°±ì‹ .
        videoJSONArr[currentIndex].progTime = getTime();

        //ë³€ê²½ ì „ video ì‹¤ì œ ì‹œì²­ì‹œê°„ì„ jsonArrì— ê°±ì‹ .
        videoJSONArr[currentIndex].actualTime = realTime;

        //index ë²ˆí˜¸ë¡œ ì˜ìƒ ì¬ìƒ ë° ì‹œê°„ ì§€ì •
        loadVideo(videoData.videoUrl, startTime);

        //ëª©ë¡ì—ì„œ í˜„ì¬ ì˜ìƒ í•˜ì´ë¼ì´íŠ¸.
        updateRowHighlight(index);

        currentIndex = index; // ì „ì—­ ë³€ìˆ˜ë¡œ í˜„ì¬ ë²ˆí˜¸ ì €ì¥.
        realTime = videoData.actualTime; //ì‹¤ì œ ì‹œì²­ì‹œê°„
      } //function

      //ê°•ì˜ ëª©ë¡ì—ì„œ í˜„ì¬ ì˜ìƒì— í•˜ì´ë¼ì´íŠ¸ íš¨ê³¼.
      function updateRowHighlight(index) {
        const $targetRow = $("#row-" + index); // IDë¡œ ëŒ€ìƒ í–‰ ì„ íƒ

        if ($targetRow.length > 0) {
          // 1. í•´ë‹¹ í–‰ì— Bootstrap ê°•ì¡° í´ë˜ìŠ¤ ì¶”ê°€
          // 2. í˜•ì œ ìš”ì†Œ(siblings)ë“¤ì—ì„œëŠ” í•´ë‹¹ í´ë˜ìŠ¤ ì œê±° (í•œ ë²ˆì— ì²˜ë¦¬)
          $targetRow
            .addClass("table-primary fw-bold")
            .siblings()
            .removeClass("table-primary fw-bold");

          // 3. ì„ íƒëœ í–‰ì´ í™”ë©´ ì¤‘ì•™ì— ë³´ì´ë„ë¡ ìŠ¤í¬ë¡¤ (jQuery ì• ë‹ˆë©”ì´ì…˜ íš¨ê³¼)
          $("html, body").animate(
            {
              scrollTop: $targetRow.offset().top - $(window).height() / 2,
            },
            500,
          );
        }
      } //function

      //ì˜ìƒ ê¸°ë¡ì„ ajaxë¡œ DB ì €ì¥.
      function uploadRecord() {
        console.log(player);

        const currentTime = getTime();
        const videoLength = getVideoLength();
        const actualTime = realTime;

        const saveData = {
          userId: videoData.userId || "noName", //ë‚˜ì¤‘ì— idëŠ” sessionì—ì„œ ë°›ì•„ì˜¬ ê²ƒ.-> ì™„ë£Œ
          chptrId: videoData.chptrId || "unknown",
          progTime: currentTime || 0,
          videoLength: videoLength || 0,
          actualTime: actualTime || 0,
        };

        console.log(saveData);

        $.ajax({
          url: "/lecture/chapter/saveRecord",
          type: "POST",
          contentType: "application/json",
          data: JSON.stringify(saveData),
          error: function (xhr) {
            alert("ì‹œì²­ ì´ë ¥ì„ ì €ì¥í•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤!");
          },
          success: function (response) {
            console.log(response);
          },
        }); //ajax
      } //function

      //ê°•ì˜ ëª©ë¡ì˜ ì‹œì²­ ì‹œê°„ì„ ê°±ì‹ í•œë‹¤.
      function updateCurrentTimeOnTable(index) {
        const $targetRow = $("#row-" + index);
        if ($targetRow.length > 0) {
          $targetRow.find(".videoCurrentTime").text(convertHms(getTime()));
        }
      } //function

      //ì´ˆ -> ì‹œ:ë¶„:ì´ˆë¡œ ë³€í™˜.
      function convertHms(seconds) {
        if (seconds < 61) {
          return "00:" + addZero(seconds);
        }
        // sec
        var hours = Math.floor(seconds / 3600);
        var mins = Math.floor((seconds - hours * 3600) / 60);
        var secs = seconds - hours * 3600 - mins * 60;
        if (hours > 0) {
          return addZero(hours) + ":" + addZero(mins) + ":" + addZero(secs);
        } else {
          return addZero(mins) + ":" + addZero(secs);
        }
        function addZero(num) {
          return (num < 10 ? "0" : "") + num;
        }
      } //function

      //************* Youtube API Setting *******************
      // 2. This code loads the IFrame Player API code asynchronously.
      var tag = document.createElement("script");

      tag.src = "https://www.youtube.com/iframe_api";
      var firstScriptTag = document.getElementsByTagName("script")[0];
      firstScriptTag.parentNode.insertBefore(tag, firstScriptTag);

      // 3. This function creates an <iframe> (and YouTube player)
      //          after the API code downloads.

      function onYouTubeIframeAPIReady() {
        if (videoData && videoData.progTime) {
          player = new YT.Player("player", {
            height: "390",
            width: "640",
            videoId: videoData.videoUrl, //modelì—ì„œ url ê°€ì ¸ì˜´

            playerVars: {
              playsinline: 1,
              //'autoplay': 1,
              //'mute': 1, //ì†Œë¦¬ ì¼œì ¸ìˆìœ¼ë©´ ë¸Œë¼ìš°ì €ì—ì„œ ìë™ ì¬ìƒ ë§‰ìŒ.
            },
            events: {
              onReady: onPlayerReady,
              //onStateChange: onPlayerStateChange,
            },
          });
        }
      }

      // 4. The API will call this function when the video player is ready.
      function onPlayerReady(event) {
        moveTime(videoData.progTime); //modelê°’ìœ¼ë¡œ ì‹œê°„ ì„¤ì •
        event.target.playVideo(); //ì˜ìƒ ì¬ìƒ

        // í”Œë ˆì´ì–´ê°€ ì¤€ë¹„ë˜ì—ˆì„ ë•Œ ë¡œë”© ìŠ¤í”¼ë„ˆ ìˆ¨ê¸°ê³ , í™”ë©´ì„ í•œë²ˆì— ë³´ì—¬ì¤Œ
        $("#loading").hide();
        $(".playerSection").addClass("loaded");
      } //func

      //***************ë™ì˜ìƒ í•¨ìˆ˜**********************
      var done = false;
      function onPlayerStateChange(event) {
        // if (event.data == YT.PlayerState.PLAYING && !done) {
        //   setTimeout(stopVideo, 6000);
        //   done = true;
        // }
        if (event.data != YT.PlayerState.PLAYING) {
          lastTime = getTime();
        }
      }

      function stopVideo() {
        player.stopVideo();
      }

      //ì˜ìƒ ìŒì†Œê±°
      function muteVideo() {
        player.mute();
      }

      //í˜„ì¬ ì˜ìƒ ì‹œê°„ ì¶”ì¶œí•˜ê¸°
      function getTime() {
        return Math.floor(player.getCurrentTime());
      } //

      //í…ŒìŠ¤íŠ¸ìš© ì‹œê°„ ì¶”ì¶œí•˜ê¸°
      function getVideoLength() {
        return Math.floor(player.getDuration());
      } //

      //ì‹œê°„ ì´ë™
      function moveTime(sec) {
        if (sec == 0 || !sec) {
          sec = 0;
        }
        player.seekTo(sec, true);
      }

      //ë°›ì€ idë¡œ ì˜ìƒ êµì²´ ë° ì˜ìƒì‹œê°„ ì§€ì •(ì‹œê°„ ì—†ìœ¼ë©´ 0ìœ¼ë¡œ).
      function loadVideo(videoId, progTime) {
        if (progTime == 0 || !progTime) {
          progTime = 0;
        }
        player.loadVideoById(videoId, progTime);
      } //func

      //*************************************
    </script>
  </head>
  <body>
    <div id="wrap">
      <div id="container">
        <h3 class="title">ìœ íŠœë¸Œ ê°•ì˜í™”ë©´</h3>
        <div class="testSection">
          <h5>
            ğŸ—‚ï¸ ì„ì‹œ sessionì˜ userId : ğŸ§‘â€ğŸ“<span
              th:text="${session.userId}"
            ></span>
          </h5>
          <span>ë§ˆì§€ë§‰ ì‹œì²­ì‹œê°„ : </span>
          <h4 id="lastTime">ì‹œê°„</h4>
          <span>ì‹¤ì œ ì‹œì²­ì¸ì •ì‹œê°„ : </span>
          <h4 id="realTime">ì‹œê°„</h4>
        </div>
        <!--ë¡œë”© í™”ë©´ -->
        <div id="loading" class="text-center">
          <div class="spinner-border text-primary" role="status">
            <span class="visually-hidden">Loading...</span>
          </div>
          <p>ê°•ì˜ë¥¼ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘ì…ë‹ˆë‹¤...</p>
        </div>
        <!-- ë™ì˜ìƒ ì˜ì—­  -->
        <div class="playerSection">
          <!-- 1. The <iframe> (and video player) will replace this <div> tag. -->
          <div>
            <div id="player" alt="ì—¬ê¸°ì„œ ìœ íŠœë¸Œ í”Œë ˆì´ê°€ ë“¤ì–´ê°„ë‹¤."></div>
          </div>
          <div>
            <table class="table table-hover">
              <thead>
                <tr>
                  <th colspan="4">ê°•ì˜ ì„ íƒ</th>
                </tr>
                <tr>
                  <th style="width: 50px">ë²ˆí˜¸</th>
                  <th style="width: 150px">ê°•ì˜ëª…</th>
                  <th style="width: 100px">ê°•ì˜ì‹œê°„</th>
                  <th style="width: 100px">ì‹œì²­ì´ë ¥</th>
                </tr>
              </thead>
              <tbody>
                <th:block th:if="${vdList.empty}">
                  <tr>
                    <td colspan="4" style="text-align: center">
                      ë°ì´í„°ê°€ ì¡´ì¬í•˜ì§€ ì•ŠìŠµë‹ˆë‹¤
                    </td>
                  </tr>
                </th:block>

                <tr
                  th:each="vd, i : ${vdList}"
                  th:object="${vd}"
                  th:id="'row-' + ${i.index}"
                  class="video-row"
                  style="cursor: pointer"
                  th:onclick="|changeView(${i.index})|"
                >
                  <td th:text="*{num}">ë²ˆí˜¸</td>
                  <td th:text="*{title}">ê°•ì˜ëª…</td>
                  <td th:text="*{videoLengthStr}">ê°•ì˜ì‹œê°„</td>
                  <td class="videoCurrentTime" th:text="*{progTimeStr}">
                    ì‹œì²­ì´ë ¥
                  </td>
                </tr>
              </tbody>
            </table>
          </div>
        </div>
        <!-- <div id="playerSection"> -->
        <hr />
        <div class="btnSection">
          <span>
            <button id="btnPrev" class="btn btn-sm btn-success">
              ì´ì „ ì˜ìƒ
            </button>
            <button id="btnNext" class="btn btn-sm btn-primary">
              ë‹¤ìŒ ì˜ìƒ
            </button>
            <button
              id="btTest"
              class="btn btn-sm btn-dark"
              onclick="uploadRecord()"
            >
              TEST
            </button>
          </span>
          <button id="btnExit" class="btn btn-sm btn-danger">ì˜ìƒ ì¢…ë£Œ</button>
        </div>
        <div class="videoData">
          <ul></ul>
        </div>
        <div class="result">
          <span></span>
        </div>
      </div>
      <!--"container" -->
    </div>
  </body>
</html>
