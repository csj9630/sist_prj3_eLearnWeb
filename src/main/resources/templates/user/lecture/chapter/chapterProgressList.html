<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <title>학습 진도 내역 - intlearn</title>
    <th:block th:replace="~{fragments/cdn :: cdn}"></th:block>
    <link rel="stylesheet" th:href="@{/css/chapter-progress.css}">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
</head>
<body>
    <th:block th:replace="~{fragments/MyHeader :: header}"></th:block>

    <div class="progress-container">
        <div class="course-header">
		    <h2 th:text="${lectName != null ? lectName : '수강 강의 정보'}">강의 제목</h2>
		    
		    <div class="course-info-summary">
		        <i class="far fa-play-circle"></i> 총 
		        <span th:text="${chapterProgress != null ? #lists.size(chapterProgress) : 0}">0</span>개 강의
		        </div>
		</div>

        <div class="chapter-list-card">
            <div th:if="${#lists.isEmpty(chapterProgress)}" class="chapter-item" style="justify-content: center; padding: 50px; color: #999;">
                수강 가능한 강의 데이터가 없습니다.
            </div>

            <div th:each="cp : ${chapterProgress}" class="chapter-item">
                <div class="chapter-status" th:classappend="${cp.state == 2 ? 'completed' : ''}">
                    <i th:class="${cp.state == 2 ? 'fas fa-check-circle' : 'far fa-circle'}"></i>
                </div>

                <div class="chapter-main">
                    <a th:href="@{/user/lecture/chapter/watch(chptrId=${cp.chptrId})}" 
                       class="chapter-title" 
                       th:text="${cp.num + '차시. ' + cp.name}">차시 제목</a>
                    
                    <div class="progress-wrapper">
                        <div class="custom-progress">
                            <div class="progress-fill" th:style="|width: ${cp.progress}%|"></div>
                        </div>
                        <div class="progress-percent" th:text="${cp.progress + '%'}">0%</div>
                    </div>
                    
                    <div class="chapter-time">
                        <i class="far fa-clock"></i> 
                        학습 지점: <span th:text="${cp.progTimeStr}">00:00</span> / <span th:text="${cp.lengthStr}">00:00</span>
                    </div>
                </div>

               <div class="chapter-action d-flex align-items-center">
				    <th:block th:if="${cp.doc != null and cp.doc != ''}">
				        <a th:href="@{/lecture/chapter/download(chptrId=${cp.chptrId})}" 
				           class="btn btn-sm btn-outline-secondary me-2" 
				           title="강의 자료 다운로드"
				           style="border-radius: 20px; padding: 6px 12px; font-size: 13px;">
				            <i class="fas fa-file-download"></i> 자료
				        </a>
				    </th:block>
				
				    <a th:href="@{/lecture/chapter/video(lectId=${lectId},chptrId=${cp.chptrId})}"
				       class="btn btn-sm" 
				       th:classappend="${cp.state == 2 ? 'btn-outline-success' : 'btn-primary'}"
				       style="border-radius: 20px; padding: 6px 18px; font-weight: 600;">
				       
				       <span th:switch="${cp.state}">
				           <span th:case="0">학습 시작</span>
				           <span th:case="2">다시보기</span>
				           <span th:case="*">이어서 학습</span>
				       </span>
				    </a>
				</div>
            </div>
        </div>

        <div class="exam-card">
            <div class="exam-info">
                <h4><i class="fas fa-award text-warning"></i> 강의 수료 시험</h4>
                <div class="exam-status-msg">
                    <span th:if="${isExamReady}" class="text-success fw-bold">
                        <i class="fas fa-unlock"></i> 축하합니다! 모든 과정을 이수하여 시험 응시가 가능합니다.
                    </span>
                    <span th:unless="${isExamReady}" class="text-muted">
                        <i class="fas fa-lock"></i> 모든 강의 진도율이 100%가 되어야 시험에 응시할 수 있습니다.
                    </span>
                    
                    <span th:if="${examScore != null}" class="score-badge">
                        최근 점수: <span th:text="${examScore}">0</span>점
                    </span>
                </div>
            </div>
            
            <button type="button" class="btn-exam"
                    th:disabled="${!isExamReady}"
                    th:onclick="handleExamStart([[${lectId}]], [[${isExamReady}]])">
                <span th:text="${isExamReady ? '📝 시험 응시하기' : '학습 진행 중'}"></span>
            </button>
        </div>
    </div>

    <th:block th:replace="~{fragments/footer :: footer}"></th:block>

    <script th:inline="javascript">
        function handleExamStart(lectId, isReady) {
            if (!isReady) {
                alert("아직 모든 강의를 완료하지 않았습니다.");
                return;
            }
            if (confirm("시험을 시작하시겠습니까? 확인을 누르면 시험 페이지로 이동합니다.")) {
            	const examUrl = /*[[@{/user/lecture/test/choiceTestFrm(lectId=${lectId})}]]*/ '/user/lecture/test/choiceTestFrm?lectId=' + lectId;
                
                location.href = examUrl;
            }
        }
    </script>
</body>
</html>