<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">
<head>
<meta charset="UTF-8">
<title>Insert title here</title>

<th:block th:replace="~{fragments/cdn :: cdn}"></th:block>

<style type="text/css">
#wrap {
	margin: 0px auto;
	width: 1200px;
	height: 1000px;
}

#header {
	height: 150px;
}

#container {
	height: 700px;
}

#footer {
	height: 150px;
}
</style>

<!--JS 실습 파트-->
<script type="text/javascript">
	$(function() {
	});//document.ready
	
	/**
	 * 시험 응시 핸들러
	 * @param {string} lectId - 강의 ID
	 * @param {boolean} isReady - 응시 가능 여부
	 */
	function handleExamStart(lectId, isReady) {
	    // 비활성화된 버튼을 뚫고 들어올 경우
	    if (!isReady) {
	        alert("아직 수강 완료하지 않은 강의가 있습니다. 모든 강의를 시청해 주세요.");
	        return;
	    }

	    // 2. 시험 시작 전 컨펌창 (추가/수정 용이)
	    if (!confirm("시험에 응시하시겠습니까?\n응시 중에는 창을 닫지 마세요.")) {
	        return;
	    }

	    // ******************URL 지정***************************
	    //const examUrl = `/exam/take?lectId=${lectId}`;
	    const examUrl = '/csj';//테스트용
	    
	    
	    // 페이지 이동
	    location.href = examUrl;
	}//func
	
	function checkAndDownload(chptrId) {
		
	    // 1. 서버에 파일 존재 여부 확인 요청
	    fetch(`/lecture/chapter/checkFile?chptrId=${chptrId}`)
	        .then(response => response.json())
	        .then(data => {
	            if (data.exists) {
	                // 2. 파일이 있으면 실제 다운로드 실행
	                // (이 경로는 기존에 만든 ResponseEntity 반환 메서드와 연결됨)
	                location.href = `/lecture/chapter/download?chptrId=${chptrId}`;
	            } else {
	                // 3. 파일이 없으면 알림창 출력
	                alert("죄송합니다. 서버에 실제 파일이 존재하지 않거나 찾을 수 없습니다.");
	            }
	        })
	        .catch(error => {
	            console.error('Error:', error);
	            alert("서버 통신 중 오류가 발생했습니다.");
	        });
	}
</script>
</head>
<body>
	<div id="wrap">
		<div id="container">

			<h3>강의 수강리스트</h3>


			<table class="table table-hover">
				<thead>
					<tr>
						<th style="width: 150px;">강의명</th>
						<th style="width: 100px;">강의시간</th>
						<th style="width: 150px;">업로드날짜</th>
						<th style="width: 150px;">강의자료</th>
						<th style="width: 150px;">강의진척률</th>
						<th style="width: 70px;">출석여부</th>
						<th style="width: 200px;">강의시청</th>
					</tr>
				</thead>
				<tbody>

					<th:block th:if="${chapterProgress.empty}">
						<tr>
							<td colspan="7" style="text-align: center;">데이터가 존재하지 않습니다</td>
						</tr>
					</th:block>

					<tr th:each="cdto, i : ${chapterProgress}" th:object="${cdto}">
						<td th:text="*{name}">01강 객체지향의 이해</td>
						<td th:text="*{lengthStr}">24:30</td>
						<td th:text="*{#dates.format(regdate, 'yyyy-MM-dd')}">2024-05-20</td>

						<td><th:block th:if="*{not #strings.isEmpty(doc)}">
								<button type="button" class="btn btn-sm btn-outline-info"
									th:text="| 📥 자료 받기 : *{doc} |"
									th:onclick="checkAndDownload([[*{chptrId}]])">📥 자료 받기
								</button>
							</th:block> <span th:unless="*{not #strings.isEmpty(doc)}"
							class="text-muted" style="font-size: 0.8em;"> 준비중 </span></td>



						<td th:text="|*{progress}%|"></td>
						<td th:text="*{stateStr}"></td>
						<td><a
							th:href="@{/lecture/chapter/video(lectId=${lectId}, chptrId=*{chptrId})}"
							class="btn btn-sm btn-info">▶️</a></td>
					</tr>

				<tfoot th:if="${not #lists.isEmpty(chapterProgress)}">
					<tr
						style="background-color: #f8f9fa; border-top: 2px solid #dee2e6;">
                        <td colspan="4">
                            <strong th:if="${isExamReady}"
							class="text-primary">
                                ✅ 모든 강의 수강 완료! 시험 응시가 가능합니다.
                            </strong>
                            <strong th:unless="${isExamReady}"
							class="text-danger">
                                🔒 모든 강의를 100% 수강해야 시험에 응시할 수 있습니다.
                            </strong>
                        </td>
                        
						<td colspan="2" class="text-center align-middle">
						    <span class="badge"
						          th:classappend="${isExamReady ? 'text-bg-primary' : 'text-bg-secondary'}"
						          style="font-size: 0.9em; padding: 0.5em 0.8em;">
						        시험 점수: 
						        <b th:text="${examScore != null ? examScore + '점' : '-'}">-</b>
						    </span>
						</td>
                        
                        <td style="text-align: center;">
                            <button type="button" id="examBtn"
								class="btn w-100"
								th:classappend="${isExamReady ? 'btn-primary' : 'btn-secondary'}"
								th:disabled="${!isExamReady}"
								th:onclick="handleExamStart([[${lectId}]], [[${isExamReady}]])">
                                <span
									th:text="${isExamReady ? '📝 시험 응시' : '응시 불가'}"></span>
                            </button>
                        </td>
                    </tr>
                </tfoot>
				</tbody>
				
			</table>
			

			
		</div>
		<!--"container" -->


	</div>


</body>
</html>