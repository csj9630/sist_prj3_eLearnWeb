<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper
  PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
  "https://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="kr.co.sist.user.lecture.test.StuTestMapper">

<!-- 강의 ID로 시험 문제 하나 조회해서 사용자 화면에 뿌려주기 -->
<select id="selectUserTest" resultType="stuTestDomain" parameterType="string">
select t.test_id as id,lect_id as lectId,test_q_id as qid,num,content,opt1,opt2,opt3,opt4,ans,exp, 
(select name from lecture where lect_id = t.lect_id) as lectName
from test t, test_question tq
where t.test_id = tq.test_id AND
tq.test_id =
(select test_id
from test
where lect_id = #{lectId})
</select>

<!-- TEST테이블에 값 삽입 -->
<insert id="insertTest" parameterType="InstTestDTO">
    <selectKey keyProperty="id" resultType="string" order="BEFORE">
        SELECT 'T' || SEQ_TEST_ID.NEXTVAL FROM DUAL
    </selectKey>

    INSERT INTO test(test_id, lect_id)
    VALUES (#{id}, #{lectId})
</insert>


<!-- 시험 정보 삭제하기 -->
<delete id="deleteOneInstTest" parameterType="instTestViewDTO">
DELETE FROM TEST_QUESTION
WHERE TEST_Q_ID = #{qid}
  AND TEST_ID IN (
      SELECT t.TEST_ID
      FROM TEST t
      JOIN LECTURE l ON t.LECT_ID = l.LECT_ID
      WHERE l.INST_ID = #{instId}
        AND l.LECT_ID = #{lectId}
  )
</delete>
<!-- 시험 문제 수정 기능 -->
<update id="updateInstTest" parameterType="InstTestDTO">
    UPDATE TEST_QUESTION
    SET 
        CONTENT = #{content},
        OPT1 = #{opt1},
        OPT2 = #{opt2},
        OPT3 = #{opt3},
        OPT4 = #{opt4},
        ANS = #{ans},
        EXP = #{exp}
    WHERE TEST_Q_ID = #{qid}
      AND TEST_ID = (
          SELECT t.TEST_ID
          FROM TEST t
          JOIN LECTURE l ON t.LECT_ID = l.LECT_ID
          WHERE l.INST_ID = #{instId}
            AND l.LECT_ID = #{lectId}
            AND t.TEST_ID = TEST_QUESTION.TEST_ID
      )
</update>


</mapper>